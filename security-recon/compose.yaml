---
# Security Reconnaissance Stack - Passive OSINT from Multiple Geolocations
# Purpose: Service detection and fingerprinting via VPN-routed containers
# Usage: Manual execution - change SERVER_REGIONS in .env, restart Gluetun, run tools

services:
  #
  # ==================================================================================
  # Gluetun VPN Gateway
  # All reconnaissance tools share this container's network namespace
  # ==================================================================================
  #
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun-recon
    hostname: gluetun-recon
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${DOCKER_ROOT}/Stacks/security-recon/gluetun:/gluetun
    env_file:
      - .env
      - ${DOCKER_ROOT}/Secrets/vpn.env  # VPN credentials (OPENVPN_USER, OPENVPN_PASSWORD)
    restart: unless-stopped
    # No ports needed - tools run internally and write to mounted volumes


  #
  # ==================================================================================
  # Nmap - Network Mapper (Service Detection)
  # https://nmap.org/
  # ==================================================================================
  #
  nmap:
    image: instrumentisto/nmap:latest
    container_name: nmap-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    # Run on-demand: docker compose run --rm nmap -sT -sV -T2 -p 22,25,80,443,3306,53,8080 scanme.nmap.org
    # Safe options: -sT (TCP connect), -sV (version detection), -T2 (polite timing)
    # Output: nmap -sT -sV -T2 -p 22,25,80,443,3306,53,8080 -oN /results/scanme/nmap.txt scanme.nmap.org


  #
  # ==================================================================================
  # WhatWeb - Web Application Fingerprinting
  # https://github.com/urbanadventurer/WhatWeb
  # ==================================================================================
  #
  whatweb:
    image: urbanadventurer/whatweb:latest
    container_name: whatweb-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    # Run on-demand: docker compose run --rm whatweb -a 1 --log-json=/results/scanme/whatweb.json scanme.nmap.org
    # -a 1 = stealthy mode (passive, single HTTP request)
    # Detects: Web server, CMS, frameworks, JavaScript libraries


  #
  # ==================================================================================
  # SSLScan / Nmap SSL Scripts - TLS/Certificate Analysis
  # Using nmap with SSL scripts for certificate and cipher analysis
  # ==================================================================================
  #
  sslscan:
    image: instrumentisto/nmap:latest
    container_name: sslscan-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    entrypoint: ["/bin/sh"]
    # Run on-demand: docker compose run --rm sslscan -c "nmap -p 443 --script ssl-cert,ssl-enum-ciphers -oN /results/scanme/sslscan.txt scanme.nmap.org"
    # Detects: SSL/TLS versions, certificate chain, cipher suites, weak configs


  #
  # ==================================================================================
  # DNSRecon - DNS Enumeration
  # https://github.com/darkoperator/dnsrecon
  # ==================================================================================
  #
  dnsrecon:
    image: michaelwilde/dnsrecon:latest
    container_name: dnsrecon-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    # Run on-demand: docker compose run --rm dnsrecon -d scanme.nmap.org -t std -o /results/scanme/dnsrecon.txt
    # -t std = standard enumeration (A, AAAA, MX, NS, SOA, TXT)
    # -o = output file
    # Detects: DNS records, nameservers, mail servers


  #
  # ==================================================================================
  # theHarvester - OSINT Email/Subdomain Discovery
  # https://github.com/laramies/theHarvester
  # ==================================================================================
  #
  theharvester:
    image: kurobeats/theharvester:latest
    container_name: theharvester-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    # Run on-demand: docker compose run --rm theharvester -d scanme.nmap.org -b google,bing,duckduckgo -f /results/scanme/theharvester
    # Completely passive - searches public search engines only
    # Detects: Email addresses, subdomains, IPs from indexed pages


  #
  # ==================================================================================
  # cURL - Simple HTTP testing and header inspection
  # ==================================================================================
  #
  curl:
    image: curlimages/curl:latest
    container_name: curl-recon
    network_mode: "service:gluetun"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./results:/results
    entrypoint: ["curl"]
    # Run on-demand: docker compose run --rm curl -I -L https://scanme.nmap.org > results/scanme/curl-headers.txt
    # -I = headers only, -L = follow redirects
    # Detects: Server headers, cookies, redirects
    # Note: Output redirect (>) must be done from host, not inside container


# No networks needed - all tools use Gluetun's network stack
# Gluetun connects to VPN, tools inherit that connection
